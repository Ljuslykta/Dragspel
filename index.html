<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notvisare - Dur & Moll</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding: 20px; }
        h1 { color: #333; margin-bottom: 10px; }
        
        .controls { margin-bottom: 20px; background: #fff; padding: 15px; display: inline-block; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        select { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; margin-left: 10px; }
        
        #canvas-container { position: relative; display: inline-block; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        canvas { display: block; }
        
        #note-info { margin-top: 10px; min-height: 60px; }
        #note-name { font-size: 40px; font-weight: bold; color: #d32f2f; display: inline-block; margin-right: 15px; }
        #frequency { color: #666; font-size: 14px; display: inline-block; vertical-align: middle; }
        
        button#startBtn { background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 5px; cursor: pointer; margin: 20px 0; }
        button#startBtn:hover { background: #0056b3; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>ðŸŽµ Notvisare (Dur & Moll)</h1>

    <div class="controls">
        <label for="keySelect">VÃ¤lj Tonart:</label>
        <select id="keySelect">
            <optgroup label="Dur (Major)">
                <option value="C">C-dur (0)</option>
                <option value="G">G-dur (1 #)</option>
                <option value="D">D-dur (2 #)</option>
                <option value="A">A-dur (3 #)</option>
                <option value="E">E-dur (4 #)</option>
                <option value="F">F-dur (1 â™­)</option>
                <option value="Bb">Bb-dur (2 â™­)</option>
                <option value="Eb">Eb-dur (3 â™­)</option>
            </optgroup>
            <optgroup label="Moll (Minor)">
                <option value="Am">A-moll (0)</option>
                <option value="Em">E-moll (1 #)</option>
                <option value="Bm">B-moll (2 #)</option>
                <option value="F#m">F#-moll (3 #)</option>
                <option value="C#m">C#-moll (4 #)</option>
                <option value="Dm">D-moll (1 â™­)</option>
                <option value="Gm">G-moll (2 â™­)</option>
                <option value="Cm">C-moll (3 â™­)</option>
            </optgroup>
        </select>
    </div>
    
    <br>
    <button id="startBtn">Starta Mikrofonen</button>

    <div id="content" class="hidden">
        <div id="canvas-container">
            <canvas id="staffCanvas" width="500" height="300"></canvas>
        </div>
        <div id="note-info">
            <span id="note-name">--</span>
            <span id="frequency">0 Hz</span>
        </div>
    </div>

    <script>
        // --- INSTÃ„LLNINGAR & VARIABLER ---
        const canvas = document.getElementById('staffCanvas');
        const ctx = canvas.getContext('2d');
        const noteDisplay = document.getElementById('note-name');
        const freqDisplay = document.getElementById('frequency');
        const keySelect = document.getElementById('keySelect');
        
        let audioContext, analyser, microphone, dataArray;
        let currentKey = "C";

        // --- MUSIKTEORI DATA ---
        
        // HÃ¤r definierar vi vilka noter som ingÃ¥r i skalan (Naturell moll anvÃ¤nds fÃ¶r basen).
        // Om man spelar harmonisk moll (hÃ¶jd sjua) kommer koden automatiskt sÃ¤tta ut ett tillfÃ¤lligt fÃ¶rtecken (#)
        // eftersom den noten inte finns med i listan nedan. Det blir korrekt notskrift.
        const keyDefinitions = {
            // DUR
            "C":  { type: "sharp", count: 0, notes: ["C", "D", "E", "F", "G", "A", "B"] },
            "G":  { type: "sharp", count: 1, notes: ["G", "A", "B", "C", "D", "E", "F#"] },
            "D":  { type: "sharp", count: 2, notes: ["D", "E", "F#", "G", "A", "B", "C#"] },
            "A":  { type: "sharp", count: 3, notes: ["A", "B", "C#", "D", "E", "F#", "G#"] },
            "E":  { type: "sharp", count: 4, notes: ["E", "F#", "G#", "A", "B", "C#", "D#"] },
            "F":  { type: "flat",  count: 1, notes: ["F", "G", "A", "Bb", "C", "D", "E"] },
            "Bb": { type: "flat",  count: 2, notes: ["Bb", "C", "D", "Eb", "F", "G", "A"] },
            "Eb": { type: "flat",  count: 3, notes: ["Eb", "F", "G", "Ab", "Bb", "C", "D"] },
            
            // MOLL (Parallelltonarter)
            "Am": { type: "sharp", count: 0, notes: ["A", "B", "C", "D", "E", "F", "G"] }, // Parallell till C
            "Em": { type: "sharp", count: 1, notes: ["E", "F#", "G", "A", "B", "C", "D"] }, // Parallell till G
            "Bm": { type: "sharp", count: 2, notes: ["B", "C#", "D", "E", "F#", "G", "A"] }, // Parallell till D
            "F#m":{ type: "sharp", count: 3, notes: ["F#", "G#", "A", "B", "C#", "D", "E"] }, // Parallell till A
            "C#m":{ type: "sharp", count: 4, notes: ["C#", "D#", "E", "F#", "G#", "A", "B"] }, // Parallell till E
            "Dm": { type: "flat",  count: 1, notes: ["D", "E", "F", "G", "A", "Bb", "C"] }, // Parallell till F
            "Gm": { type: "flat",  count: 2, notes: ["G", "A", "Bb", "C", "D", "Eb", "F"] }, // Parallell till Bb
            "Cm": { type: "flat",  count: 3, notes: ["C", "D", "Eb", "F", "G", "Ab", "Bb"] }  // Parallell till Eb
        };

        const sharpPositions = [4, 1, 5, 2]; // F, C, G, D
        const flatPositions = [0, 3, -1];    // B, E, A
        const sharpNotes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const flatNotes  = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        
        keySelect.addEventListener('change', (e) => { currentKey = e.target.value; });

        document.getElementById('startBtn').addEventListener('click', async () => {
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            await startAudio();
            drawLoop();
        });

        async function startAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                dataArray = new Float32Array(analyser.fftSize);
            } catch (err) { alert("Mikrofonproblem."); }
        }

        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length, rms = 0;
            for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
            if (Math.sqrt(rms / SIZE) < 0.015) return -1;

            let r1 = 0, r2 = SIZE - 1, thres = 0.2;
            for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
            buf = buf.slice(r1, r2); SIZE = buf.length;

            let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) for (let j = 0; j < SIZE - i; j++) c[i] += buf[j] * buf[j + i];
            
            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
            return sampleRate / maxpos;
        }

        function getNoteInfo(frequency) {
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            const midiNote = Math.round(noteNum) + 69;
            const keyData = keyDefinitions[currentKey];
            const noteList = keyData.type === "flat" ? flatNotes : sharpNotes;
            const rawNoteName = noteList[midiNote % 12];
            const octave = Math.floor(midiNote / 12) - 1;
            return { midiNote, rawNoteName, octave };
        }

        function drawStaff(settings) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.fillStyle = "#000";
            const { startY, lineSpacing } = settings;
            for (let i = 0; i < 5; i++) {
                let y = startY + (i * lineSpacing);
                ctx.beginPath(); ctx.moveTo(20, y); ctx.lineTo(480, y); ctx.stroke();
            }
            ctx.font = "60px serif"; ctx.fillText("ð„ž", 20, startY + 3 * lineSpacing);
            drawKeySignature(settings);
        }

        function drawKeySignature(settings) {
            const keyData = keyDefinitions[currentKey];
            const { startY, lineSpacing } = settings;
            const middleLineY = startY + 2 * lineSpacing;
            const halfStep = lineSpacing / 2;
            ctx.font = "24px serif";
            let startX = 60;

            if (keyData.type === "sharp") {
                for(let i=0; i<keyData.count; i++) {
                    let y = middleLineY - (sharpPositions[i] * halfStep) + 8;
                    ctx.fillText("â™¯", startX + (i * 15), y);
                }
            } else if (keyData.type === "flat") {
                for(let i=0; i<keyData.count; i++) {
                    let y = middleLineY - (flatPositions[i] * halfStep) + 8;
                    ctx.fillText("â™­", startX + (i * 15), y);
                }
            }
        }

        function drawNote(noteInfo, settings) {
            const keyData = keyDefinitions[currentKey];
            const scaleNotes = keyData.notes;
            
            let baseNoteChar = noteInfo.rawNoteName.charAt(0);
            let accidental = noteInfo.rawNoteName.length > 1 ? noteInfo.rawNoteName.charAt(1) : "";

            const baseNotes = ["C", "D", "E", "F", "G", "A", "B"];
            const baseIndex = baseNotes.indexOf(baseNoteChar);
            const octaveDiff = noteInfo.octave - 4;
            const visualSteps = (octaveDiff * 7) + baseIndex;
            const stepsFromB4 = visualSteps - 6;
            
            const { startY, lineSpacing } = settings;
            const middleLineY = startY + 2 * lineSpacing;
            const halfStep = lineSpacing / 2;
            const noteY = middleLineY - (stepsFromB4 * halfStep);

            let symbolToDraw = "";
            const expectedNote = scaleNotes.find(n => n.startsWith(baseNoteChar));
            
            if (noteInfo.rawNoteName !== expectedNote) {
                if (accidental === "") symbolToDraw = "â™®";
                else if (accidental === "#") symbolToDraw = "â™¯";
                else if (accidental === "b") symbolToDraw = "â™­";
            }

            ctx.beginPath();
            ctx.arc(250, noteY, 10, 0, 2 * Math.PI);
            ctx.fillStyle = "#000"; ctx.fill();
            
            if (visualSteps === 0) { // C4 HjÃ¤lplinje
                ctx.beginPath(); ctx.moveTo(230, noteY); ctx.lineTo(270, noteY); ctx.stroke();
            }

            if (symbolToDraw) {
                ctx.font = "24px serif";
                ctx.fillText(symbolToDraw, 220, noteY + 8);
            }
        }

        function drawLoop() {
            requestAnimationFrame(drawLoop);
            const settings = { startY: 100, lineSpacing: 20 };
            drawStaff(settings);

            analyser.getFloatTimeDomainData(dataArray);
            let frequency = autoCorrelate(dataArray, audioContext.sampleRate);
            
            if (frequency > 60 && frequency < 3000) {
                const info = getNoteInfo(frequency);
                noteDisplay.innerText = info.rawNoteName + info.octave;
                freqDisplay.innerText = Math.round(frequency) + " Hz";
                drawNote(info, settings);
            }
        }
    </script>
</body>
</html>
